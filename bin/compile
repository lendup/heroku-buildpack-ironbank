#!/bin/bash

BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"

##
## Constants
## 

MAVEN_URL="http://www.gtlib.gatech.edu/pub/apache/maven/maven-3/3.3.9/binaries/apache-maven-3.3.9-bin.tar.gz"
MAVEN_DIR="apache-maven"
CACHED_MAVEN_REPO=${CACHE_DIR}/.m2_repository

# NewRelic Constants
NEWRELIC_VERSION="3.31.1"
NEWRELIC_DIR="newrelic"
NEWRELIC_URL="https://download.newrelic.com/newrelic/java-agent/newrelic-agent/${NEWRELIC_VERSION}/newrelic-java-${NEWRELIC_VERSION}.zip"

##
## Code
##

# Set up Maven
if [ ! -d ${CACHE_DIR}/${MAVEN_DIR} ]; then
    mkdir -p ${CACHE_DIR}/${MAVEN_DIR}
    echo "-----> Cached Maven binary not found, downloading"
    wget -qO- ${MAVEN_URL} | tar xz -C ${CACHE_DIR}/${MAVEN_DIR} --strip-components 1
fi

# Setup NewRelic
if [ ! -d ${CACHE_DIR}/${NEWRELIC_DIR} ]; then
    mkdir -p ${CACHE_DIR}/NEWRELIC_DIR
    echo "-----> Cached NewRelic agent not found, downloading"
    echo "-----> Downloading from ${NEWRELIC_URL}..."
    wget -q ${NEWRELIC_URL} -O ${CACHE_DIR}/newrelic_tmp.zip
    unzip ${CACHE_DIR}/newrelic_tmp.zip -d ${CACHE_DIR}
    rm ${CACHE_DIR}/newrelic_tmp.zip
fi

cp -r ${CACHE_DIR}/${MAVEN_DIR} ${BUILD_DIR}
cp -r ${CACHE_DIR}/${NEWRELIC_DIR} ${BUILD_DIR}

# Build entire project
cd "$BUILD_DIR"

# Initialize Play! and precompile it.
${BUILD_DIR}/${MAVEN_DIR}/bin/mvn -P '!local' --settings ${BUILD_DIR}/assets/settings.xml -Dmaven.repo.local=${CACHED_MAVEN_REPO} clean compile play:precompile

# remove unnecessary node modules and free up space since slug is limited to <300 MB compressed
rm -rf ${BUILD_DIR}/ironbank-credit/src/main/javascript/node_modules ${BUILD_DIR}/src/main/javascript/node_modules

cp -r ${CACHED_MAVEN_REPO} ${BUILD_DIR}
